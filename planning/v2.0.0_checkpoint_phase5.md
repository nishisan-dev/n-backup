# v2.0.0 — Checkpoint: Fases 5-6 Pendentes

**Data:** 2026-02-17T01:21 BRT  
**Branch:** `dev-v2.0.0`  
**Último commit:** `1e91970` — `feat(observability): add session history ring (Phase 4)`

---

## Estado Atual — Fases Concluídas

### Fase 1: Enriquecimento do Handshake (commit anterior)
- Agent envia versão e stats (CPU, mem, disk) no control channel.

### Fase 2: WebUI Storages com Disk Usage (`eb6b9c5`)
- Endpoint `GET /api/v1/storages` retorna uso de disco via `syscall.Statfs`.

### Fase 3: Persistência de Eventos (`9592386`)
- `event_store.go`: append-only JSONL com rotação por `maxLines`.
- `event_store_test.go`: 7 testes cobrindo persistência, rotação, corrupção.
- Config: `events_file` (default `events.jsonl`) e `events_max_lines` (default 10000) em `WebUIConfig`.
- `server.go`: instancia `EventStore` na startup, `Close()` no shutdown, fallback para `/tmp`.
- `handler.go`: campo `Events` agora é `*observability.EventStore`.
- `http.go`: `NewRouter` aceita `*EventStore` como 4º arg, endpoint `GET /api/v1/events`.

### Fase 4: Histórico de Sessões Finalizadas (`1e91970`)
- `dto.go`: DTO `SessionHistoryEntry` (session_id, agent, storage, backup, mode, compression, started_at, finished_at, duration, bytes_total, result).
- `session_history.go`: `SessionHistoryRing` — ring buffer tipado thread-safe com Push/Recent.
- `handler.go`:
  - `recordSessionEnd()` helper centralizado (chamado nos 3 handlers: single, resume, parallel).
  - `SessionHistorySnapshot()` expõe o ring via interface.
  - `validateAndCommit()` retorna `(string, int64)` — resultado e dataSize.
  - `validateAndCommitWithTrailer()` retorna `string` — resultado.
- `http.go`: interface `HandlerMetrics` com `SessionHistorySnapshot()`, endpoint `GET /api/v1/sessions/history`.
- `http_test.go`: mock atualizado com `SessionHistorySnapshot()`.
- `server.go`: instancia `SessionHistoryRing(200)` na startup.

---

## Fases Pendentes

### Fase 5: Frontend (WebUI SPA)
Atualizar o frontend JS para consumir os novos endpoints:

1. **`web/api.js`** — Adicionar funções:
   - `fetchSessionHistory()` → `GET /api/v1/sessions/history`
   - Validar que `fetchEvents()` já consome `/api/v1/events` (provavelmente já existe).

2. **`web/components.js`** — Adicionar seção "Session History" na UI:
   - Tabela com colunas: Agent, Storage, Mode, Result, Duration, Bytes, Finished At.
   - Badge colorido para resultado (ok=verde, checksum_mismatch=vermelho, write_error=laranja).
   - Ordenação cronológica reversa (mais recente primeiro).

3. **`web/app.js`** — Integrar polling/fetch do histórico no ciclo de atualização.

4. **`web/index.css`** — Estilos para badges de resultado e tabela de histórico.

> **Nota:** O frontend usa vanilla JS com `go:embed`. Os arquivos estão em `internal/server/observability/web/`.

### Fase 6: Documentação e Release
- Atualizar `docs/` com as novas features.
- Diagrama PlantUML se aplicável.
- Tag e release via `gh release create`.

---

## Arquivos-chave para Referência

| Arquivo | O que contém |
|---------|-------------|
| `internal/server/observability/event_store.go` | EventStore JSONL |
| `internal/server/observability/session_history.go` | SessionHistoryRing |
| `internal/server/observability/dto.go` | Todos os DTOs da API |
| `internal/server/observability/http.go` | Router, endpoints, interface HandlerMetrics |
| `internal/server/observability/http_test.go` | Testes HTTP com mock |
| `internal/server/handler.go` | Handler principal, recordSessionEnd, validateAndCommit |
| `internal/server/server.go` | Startup WebUI, instanciação EventStore e SessionHistoryRing |
| `internal/config/server.go` | WebUIConfig com EventsFile/EventsMaxLines |
| `internal/server/observability/web/` | Frontend SPA (app.js, api.js, components.js, index.css) |

---

## Build & Testes
- `go build ./...` ✅
- `go test ./...` ✅ (todos os 8 pacotes passaram)
