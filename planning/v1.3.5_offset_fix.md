# v1.3.5 — Offset Mismatch Fix + Race Condition CI

**Tag:** `v1.3.5` — commit `0ff0ab8`
**Data:** 2026-02-15

---

## Contexto

Sessão anterior implementou 3 features (detalhes em `dscp_flow_rotation_diagnostic.md`):

1. **DSCP Configurável** — `dscp.go`, `config/agent.go`, `dispatcher.go`
2. **Diagnóstico Producer/Consumer** — contadores `producerBlockedNs`/`senderIdleNs` no `dispatcher.go`, log de bottleneck no `autoscaler.go`
3. **Flow Rotation Server-driven** — `config/server.go` (`FlowRotationConfig`), `handler.go` (`evaluateFlowRotation`, `StreamSlowSince`, `StreamLastReset`)

Todas as features foram commitadas, testadas e taggeadas como `v1.3.3` e `v1.3.4`.

---

## Bug 1: Offset Mismatch (Critical)

### Root Cause

No `receiveParallelStream` do server, `bytesReceived` contabilizava **apenas payload** — sem os 8 bytes do `ChunkHeader`. Porém, o ring buffer do agent armazena **header + payload** por chunk.

Isso causava desync progressivo em dois pontos:

| Ponto | Efeito |
|-------|--------|
| `ChunkSACK.Offset` → `rb.Advance()` | Tail do ring buffer avançava para posição errada |
| `ParallelACK.lastOffset` → `sendOffset` (resume) | Agent lia do meio de um chunk — framing corrompido |

### Fix (commit `c6d541c`)

| Arquivo | Mudança |
|---------|---------|
| `protocol/frames.go` | Nova constante `ChunkHeaderSize = 8` |
| `server/handler.go` | `bytesReceived += int64(hdr.Length) + protocol.ChunkHeaderSize` |
| `agent/dispatcher.go` | `make([]byte, protocol.ChunkHeaderSize)` (cleanup magic number) |

---

## Bug 2: Race Condition no Teste de Integração (CI Flaky)

### Root Cause

`TestEndToEnd_ParallelBackupSession` enviava `ParallelJoin` imediatamente após `ParallelInit`, sem esperar o server registrar a sessão via `sessions.Store()`. Em runners CI (Ubuntu mais lento), o Join chegava antes do Store → `ParallelStatusNotFound`.

### Fix (commit `0ff0ab8`)

Adicionado retry loop (até 10 tentativas, 50ms backoff) no `ParallelJoin` do teste de integração.

---

## Status

- [x] Build local OK
- [x] `go test ./...` OK (todos os pacotes)
- [x] Tag `v1.3.5` pushed — pipeline CI deve passar com o retry

## Pendências para Próxima Sessão

- Verificar se pipeline CI v1.3.5 passou (usar `gh run list`)
- Testes unitários específicos para DSCP e Flow Rotation (cobertura mínima existe via integration test)
- Validação manual em ambiente real: DSCP com `tcpdump -v`, Flow Rotation com tráfego degradado
