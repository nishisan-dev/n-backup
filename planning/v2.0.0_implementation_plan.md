# Plano de Implementa√ß√£o ‚Äî n-backup v2.0.0

Implementa√ß√£o das 6 fases do plano v2.0.0: protocolo, storages, persist√™ncia de eventos, hist√≥rico de sess√µes, server stats e melhorias UX.

## User Review Required

> [!IMPORTANT]
> **Backward Compatibility do Handshake (Fase 1):** O handshake do control channel ser√° estendido com version + stats. Agents antigos (sem esses campos) **n√£o ser√£o suportados** ‚Äî o server esperar√° os bytes adicionais. Confirmar que todos os agents em produ√ß√£o ser√£o atualizados simultaneamente.

> [!IMPORTANT]
> **Ordem de execu√ß√£o das fases:** As fases 1-3 s√£o independentes e podem ser feitas em qualquer ordem. A Fase 4 depende da Fase 3 (usa `EventStore`). Fases 5 e 6 s√£o independentes. Sugest√£o: executar na ordem 1 ‚Üí 2 ‚Üí 3 ‚Üí 4 ‚Üí 5 ‚Üí 6, com commits at√¥micos por fase.

---

## Fase 1: Protocolo ‚Äî Control Channel Handshake Enriquecido

### Protocolo (`internal/protocol`)

#### [MODIFY] [control.go](file:///home/lucas/Projects/n-backup/internal/protocol/control.go)
- Adicionar `WriteControlStatsRaw(w, cpu, mem, disk, load) error` ‚Äî escreve 4√ó float32 (16B) **sem** magic
- Adicionar `ReadControlStatsRaw(r) (*ControlStats, error)` ‚Äî l√™ 4√ó float32 (16B) **sem** magic
- Essas fun√ß√µes s√£o reutiliz√°veis pelo handshake e pelos testes

#### [MODIFY] [control_test.go](file:///home/lucas/Projects/n-backup/internal/protocol/control_test.go)
- `TestControlStatsRaw_RoundTrip` ‚Äî write + read sem magic, validar 4 floats

---

### Agent (`internal/agent`)

#### [MODIFY] [control_channel.go](file:///home/lucas/Projects/n-backup/internal/agent/control_channel.go)
- Adicionar campo `version string` na struct `ControlChannel`
- Em `NewControlChannel`, receber `version` (via par√¢metro ou constante de pacote via ldflags)
- Em `connect()`, ap√≥s escrever `handshake` (8B magic+keepalive):
  1. Escrever `version + "\n"` (string terminada em newline)
  2. Coletar stats iniciais via `statsProvider` (ou zeros se nil)
  3. Escrever 16B stats via `WriteControlStatsRaw`

---

### Server (`internal/server`)

#### [MODIFY] [handler.go](file:///home/lucas/Projects/n-backup/internal/server/handler.go)
- Em `ControlConnInfo`, adicionar campo `ClientVersion string`
- Em `handleControlChannel()`, ap√≥s ler `intervalBuf` (4B):
  1. Ler version via `readUntilNewline(conn)` (j√° existe a fun√ß√£o)
  2. Ler stats iniciais via `protocol.ReadControlStatsRaw(conn)` (16B)
  3. Popular `cci.ClientVersion` e `cci.Stats` imediatamente
- Em `ConnectedAgents()`, popular `ClientVersion` do `ControlConnInfo` (hoje vem s√≥ da sess√£o)

---

## Fase 2: WebUI ‚Äî Storages com Uso de Disco

### DTOs e Backend

#### [MODIFY] [dto.go](file:///home/lucas/Projects/n-backup/internal/server/observability/dto.go)
- Novo DTO `StorageUsage` com campos: `Name`, `BaseDir`, `MaxBackups`, `CompressionMode`, `AssemblerMode`, `TotalBytes`, `UsedBytes`, `FreeBytes`, `UsagePercent`, `BackupsCount`

#### [MODIFY] [handler.go](file:///home/lucas/Projects/n-backup/internal/server/handler.go)
- Novo m√©todo `StorageUsageSnapshot() []StorageUsage`:
  - Iterar `h.cfg.Storages`
  - `syscall.Statfs` no `BaseDir` ‚Üí `TotalBytes`, `FreeBytes`, `UsedBytes`
  - Contar arquivos `.tar.gz` / `.tar.zst` em subdirs do `BaseDir` ‚Üí `BackupsCount`

#### [MODIFY] [http.go](file:///home/lucas/Projects/n-backup/internal/server/observability/http.go)
- Adicionar `StorageUsageSnapshot() []StorageUsage` √† interface `HandlerMetrics`
- Registrar endpoint `GET /api/v1/storages` via `makeStoragesHandler`

#### [MODIFY] [http_test.go](file:///home/lucas/Projects/n-backup/internal/server/observability/http_test.go)
- Estender `mockMetrics` com `StorageUsageSnapshot()`
- `TestStorages_ReturnsData` ‚Äî validar JSON retornado

---

### Frontend

#### [MODIFY] [api.js](file:///home/lucas/Projects/n-backup/internal/server/observability/web/js/api.js)
- Adicionar `storages()` ‚Üí `fetch('/api/v1/storages')`

#### [MODIFY] [components.js](file:///home/lucas/Projects/n-backup/internal/server/observability/web/js/components.js)
- Nova fun√ß√£o `renderOverviewStorages(storages)` ‚Äî cards com gauges de disco, badge de compress√£o, contagem de backups

#### [MODIFY] [app.js](file:///home/lucas/Projects/n-backup/internal/server/observability/web/js/app.js)
- Chamar `API.storages()` no `fetchOverview()`, renderizar se√ß√£o Storages

#### [MODIFY] [index.html](file:///home/lucas/Projects/n-backup/internal/server/observability/web/index.html)
- Adicionar se√ß√£o `<div id="overview-storages-card">` no overview, ap√≥s Server Info

---

## Fase 3: Persist√™ncia de Eventos

#### [NEW] [event_store.go](file:///home/lucas/Projects/n-backup/internal/server/observability/event_store.go)
- `EventStore` struct: wraps `EventRing` + file handle JSONL
- `NewEventStore(path, ringCap, maxLines)` ‚Äî abre/cria arquivo, carrega √∫ltimas N linhas no ring
- `Push(e)` ‚Äî `ring.Push(e)` + append JSON line no arquivo
- `Recent(limit)` ‚Äî delega ao ring
- `Close()` ‚Äî fecha file handle
- Rota√ß√£o: quando linhas excedem `maxLines`, reescreve mantendo `maxLines/2`

#### [NEW] [event_store_test.go](file:///home/lucas/Projects/n-backup/internal/server/observability/event_store_test.go)
- `TestEventStore_PersistAndReload` ‚Äî push eventos, fechar, reabrir, validar que o ring foi recarregado
- `TestEventStore_Rotation` ‚Äî push > maxLines, validar truncamento
- `TestEventStore_FallbackWithoutFile` ‚Äî path vazio, funciona como ring puro

#### [MODIFY] [server.go](file:///home/lucas/Projects/n-backup/internal/config/server.go)
- Em `WebUIConfig`, adicionar:
  - `EventsFile string` (`yaml:"events_file"`) ‚Äî default: `"events.jsonl"`
  - `EventsMaxLines int` (`yaml:"events_max_lines"`) ‚Äî default: `10000`
- Em `validate()`, aplicar defaults

#### [MODIFY] [http.go](file:///home/lucas/Projects/n-backup/internal/server/observability/http.go)
- `NewRouter` passa a aceitar `*EventStore` em vez de `*EventRing`
- `makeEventsHandler` usa `EventStore.Recent()`

#### [MODIFY] [handler.go](file:///home/lucas/Projects/n-backup/internal/server/handler.go)
- O campo `Events` (se existir como eventRing) muda para `EventStore`
- Atualizar inicializa√ß√£o no `main.go` ou quem cria o router

---

## Fase 4: Hist√≥rico de Sess√µes Finalizadas

#### [MODIFY] [dto.go](file:///home/lucas/Projects/n-backup/internal/server/observability/dto.go)
- Novo DTO `SessionHistoryEntry`: `SessionID`, `Agent`, `Storage`, `Backup`, `BytesTotal`, `Duration`, `Result` (ok/checksum_mismatch/write_error), `FinishedAt`

#### [MODIFY] [handler.go](file:///home/lucas/Projects/n-backup/internal/server/handler.go)
- Novo campo `sessionHistory` no `Handler` ‚Äî ring buffer simples (cap ~100) de `SessionHistoryEntry`
- Na finaliza√ß√£o de `handleBackup`/`handleParallelSession`: criar e push `SessionHistoryEntry`
- Emitir evento tipado `session_complete` / `session_failed` no `EventStore`
- Novo m√©todo `SessionsHistory() []SessionHistoryEntry` (para interface)

#### [MODIFY] [http.go](file:///home/lucas/Projects/n-backup/internal/server/observability/http.go)
- Adicionar `SessionsHistory()` √† interface `HandlerMetrics`
- Endpoint `GET /api/v1/sessions/history`

#### [MODIFY] [http_test.go](file:///home/lucas/Projects/n-backup/internal/server/observability/http_test.go)
- `TestSessionsHistory_EmptyList`, `TestSessionsHistory_WithData`

### Frontend

#### [MODIFY] [api.js](file:///home/lucas/Projects/n-backup/internal/server/observability/web/js/api.js)
- `sessionsHistory()` ‚Üí `fetch('/api/v1/sessions/history')`

#### [MODIFY] [components.js](file:///home/lucas/Projects/n-backup/internal/server/observability/web/js/components.js)
- `renderSessionsHistory(entries)` ‚Äî tabela com badge de resultado (‚úÖ/‚ùå/‚ö†Ô∏è)

#### [MODIFY] [app.js](file:///home/lucas/Projects/n-backup/internal/server/observability/web/js/app.js)
- Toggle "Ativas | Recentes" na aba Sess√µes

---

## Fase 5: Server Stats (Runtime)

#### [MODIFY] [dto.go](file:///home/lucas/Projects/n-backup/internal/server/observability/dto.go)
- Novo DTO `ServerStats`: `GoRoutines`, `HeapAllocMB`, `HeapSysMB`, `GCPauseMs`, `GCCycles`, `CPUCores`

#### [MODIFY] [http.go](file:///home/lucas/Projects/n-backup/internal/server/observability/http.go)
- Enriquecer `handleHealth` com `ServerStats` no `HealthResponse`, ou criar endpoint `GET /api/v1/server/stats`
- Coletar via `runtime.NumGoroutine()`, `runtime.ReadMemStats()`, `runtime.NumCPU()`

#### [MODIFY] [components.js](file:///home/lucas/Projects/n-backup/internal/server/observability/web/js/components.js)
- Renderizar no card Server Info: Goroutines, Heap, GC Pause

#### [MODIFY] [index.html](file:///home/lucas/Projects/n-backup/internal/server/observability/web/index.html)
- Campos adicionais no info-grid

---

## Fase 6: Melhorias UX da WebUI

### 6.1 Dark/Light Theme Toggle

#### [MODIFY] [style.css](file:///home/lucas/Projects/n-backup/internal/server/observability/web/css/style.css)
- CSS variables para temas dark e light (`:root` e `[data-theme="light"]`)

#### [MODIFY] [index.html](file:///home/lucas/Projects/n-backup/internal/server/observability/web/index.html)
- Toggle üåô/‚òÄÔ∏è no topbar

#### [MODIFY] [app.js](file:///home/lucas/Projects/n-backup/internal/server/observability/web/js/app.js)
- L√≥gica de toggle + `localStorage.setItem('theme', ...)`

### 6.2 SSE para Eventos

#### [MODIFY] [event_store.go](file:///home/lucas/Projects/n-backup/internal/server/observability/event_store.go)
- Adicionar broadcast channel (slice de listeners) para notificar SSE

#### [MODIFY] [http.go](file:///home/lucas/Projects/n-backup/internal/server/observability/http.go)
- `GET /api/v1/events/stream` ‚Üí SSE handler com `text/event-stream`

#### [MODIFY] [app.js](file:///home/lucas/Projects/n-backup/internal/server/observability/web/js/app.js)
- Subscrever `EventSource` para toast de eventos `error`/`warn`

### 6.3 Export de Eventos

#### [MODIFY] [components.js](file:///home/lucas/Projects/n-backup/internal/server/observability/web/js/components.js)
- Bot√£o "Export" na aba Eventos ‚Üí download JSON/CSV (implementa√ß√£o 100% frontend)

### 6.4 Alertas Visuais

#### [MODIFY] [components.js](file:///home/lucas/Projects/n-backup/internal/server/observability/web/js/components.js)
- Regras visuais: disco > 90% ‚Üí gauge vermelho; agent offline > 5min ‚Üí warning badge; throughput < 1MB/s ‚Üí indicador amarelo

#### [MODIFY] [style.css](file:///home/lucas/Projects/n-backup/internal/server/observability/web/css/style.css)
- Classes CSS para estados de alerta

### 6.5 Responsividade Mobile

#### [MODIFY] [style.css](file:///home/lucas/Projects/n-backup/internal/server/observability/web/css/style.css)
- Media queries para viewports estreitos

### 6.6 Throughput Global Chart

#### [MODIFY] [app.js](file:///home/lucas/Projects/n-backup/internal/server/observability/web/js/app.js)
- Ring buffer global de throughput, canvas maior no card Traffic In

#### [MODIFY] [components.js](file:///home/lucas/Projects/n-backup/internal/server/observability/web/js/components.js)
- Reutilizar `drawSparkline` existente

---

## Verification Plan

### Testes Automatizados

Todos os testes existentes + novos, executados com:

```bash
cd /home/lucas/Projects/n-backup && go test ./... -v -count=1
```

Testes espec√≠ficos por fase:

| Fase | Comando | O que valida |
|:---:|---|---|
| 1 | `go test ./internal/protocol/... -v -run TestControlStatsRaw` | Round-trip da serializa√ß√£o sem magic |
| 2 | `go test ./internal/server/observability/... -v -run TestStorages` | Endpoint retorna JSON com campos corretos |
| 3 | `go test ./internal/server/observability/... -v -run TestEventStore` | Persist, reload, rotation |
| 4 | `go test ./internal/server/observability/... -v -run TestSessionsHistory` | Endpoint history |
| 5 | `go test ./internal/server/observability/... -v -run TestHealth` | Health com stats runtime inclusos |
| ALL | `go test ./... -v -count=1` | Regress√£o completa |

### Verifica√ß√£o Manual (via WebUI)

Cada fase, ao final do commit, deve ser verificada visualmente:

1. **F2 ‚Äî Storages:** Acessar WebUI ‚Üí Overview ‚Üí se√ß√£o Storages com gauges reais
2. **F3 ‚Äî Eventos:** Reiniciar server ‚Üí verificar que eventos anteriores aparecem no aba Eventos
3. **F4 ‚Äî Hist√≥rico:** Completar backup ‚Üí aba Sess√µes ‚Üí toggle "Recentes" ‚Üí ver entrada com badge
4. **F5 ‚Äî Stats:** Overview ‚Üí Server Info ‚Üí goroutines, heap, GC vis√≠veis
5. **F6.1 ‚Äî Tema:** Toggle dark/light ‚Üí recarregar p√°gina ‚Üí tema persiste
