# v2.0.0 ‚Äî Fases 5 e 6: Server Stats + UX WebUI

Implementa√ß√£o das duas fases restantes do plano v2.0.0: Server Stats (runtime Go) e melhorias UX da WebUI.

> [!IMPORTANT]
> Fases 5 e 6 s√£o independentes. F5 √© puramente backend+frontend. F6 √© 100% frontend. Commits at√¥micos por sub-feature.

---

## Fase 5: Server Stats (Runtime)

Expor m√©tricas do runtime Go no endpoint de health e renderizar no Server Info da WebUI.

### Backend

#### [MODIFY] [dto.go](file:///home/lucas/Projects/n-backup/internal/server/observability/dto.go)

- Adicionar DTO `ServerStats` ao final do arquivo:
```go
type ServerStats struct {
    GoRoutines  int     `json:"goroutines"`
    HeapAllocMB float64 `json:"heap_alloc_mb"`
    HeapSysMB   float64 `json:"heap_sys_mb"`
    GCPauseMs   float64 `json:"gc_pause_ms"`
    GCCycles    uint32  `json:"gc_cycles"`
    CPUCores    int     `json:"cpu_cores"`
}
```
- Adicionar campo `Stats *ServerStats` na `HealthResponse`

#### [MODIFY] [http.go](file:///home/lucas/Projects/n-backup/internal/server/observability/http.go)

- Na fun√ß√£o `handleHealth`: coletar stats via `runtime.ReadMemStats()` e `runtime.NumGoroutine()`, popular `ServerStats` no response.

#### [MODIFY] [http_test.go](file:///home/lucas/Projects/n-backup/internal/server/observability/http_test.go)

- Atualizar `TestHealth_ReturnsOK` para validar que `stats` est√° presente, com `goroutines > 0`, `cpu_cores > 0`.

### Frontend

#### [MODIFY] [index.html](file:///home/lucas/Projects/n-backup/internal/server/observability/web/index.html)

- No `info-grid` do "Server Info" (linha ~129-143), adicionar itens: Goroutines, Heap, GC Pause, CPU Cores.

#### [MODIFY] [components.js](file:///home/lucas/Projects/n-backup/internal/server/observability/web/js/components.js)

- Atualizar `renderServerInfo(health)` para popular os novos campos e renderizar um gauge de heap usage.

---

## Fase 6: Melhorias UX da WebUI

### 6.1 Dark/Light Theme Toggle

#### [MODIFY] [style.css](file:///home/lucas/Projects/n-backup/internal/server/observability/web/css/style.css)

- Duplicar as CSS variables do `:root` para um bloco `[data-theme="light"]` com cores claras.
- Transi√ß√£o suave no `body` para troca de tema.

#### [MODIFY] [index.html](file:///home/lucas/Projects/n-backup/internal/server/observability/web/index.html)

- Adicionar bot√£o üåô/‚òÄÔ∏è no `topbar-right`, antes do `conn-status`.

#### [MODIFY] [app.js](file:///home/lucas/Projects/n-backup/internal/server/observability/web/js/app.js)

- Event listener no bot√£o de tema: toggle `data-theme` no `document.documentElement`.
- Persistir prefer√™ncia em `localStorage('nbackup-theme')`.
- No init, aplicar tema salvo (default: dark).

### 6.3 Export de Eventos (JSON/CSV)

#### [MODIFY] [index.html](file:///home/lucas/Projects/n-backup/internal/server/observability/web/index.html)

- Adicionar bot√£o "‚¨á Export" no `view-header` da aba Eventos, ao lado do select de limit.

#### [MODIFY] [components.js](file:///home/lucas/Projects/n-backup/internal/server/observability/web/js/components.js)

- Fun√ß√£o `exportEvents(format)` ‚Üí gera Blob com dados dos eventos (j√° carregados via API) e faz download como JSON ou CSV.

#### [MODIFY] [app.js](file:///home/lucas/Projects/n-backup/internal/server/observability/web/js/app.js)

- Event listener no bot√£o export.

### 6.4 Alertas Visuais com Thresholds

#### [MODIFY] [components.js](file:///home/lucas/Projects/n-backup/internal/server/observability/web/js/components.js)

- No `renderOverviewStorages()`: se `usage_percent > 90`, aplicar classe `gauge-critical` + √≠cone ‚ö†Ô∏è.
- No `renderSessionDetail()` ou lista de streams: se throughput < 1 MB/s, indicador amarelo.

#### [MODIFY] [style.css](file:///home/lucas/Projects/n-backup/internal/server/observability/web/css/style.css)

- Classe `.gauge-critical` com borda vermelha pulsante.

### 6.6 Throughput Global Chart no Overview

#### [MODIFY] [index.html](file:///home/lucas/Projects/n-backup/internal/server/observability/web/index.html)

- Adicionar canvas `global-throughput-canvas` ao card de Traffic In.

#### [MODIFY] [app.js](file:///home/lucas/Projects/n-backup/internal/server/observability/web/js/app.js)

- Ring buffer global `throughputHistory` (max 1800 pontos).
- No `fetchOverview()`, acumular MB/s e chamar `drawSparkline()` no canvas.

---

## Verifica√ß√£o

### Testes Automatizados

```bash
# Testes do pacote observability (inclui http_test.go, event_store_test.go, etc.)
cd /home/lucas/Projects/n-backup && go test ./internal/server/observability/... -v -count=1

# Build completo
go build ./...
```

### Verifica√ß√£o Visual (Browser)

1. Abrir WebUI ‚Üí Overview ‚Üí verificar que "Server Info" mostra Goroutines, Heap, CPU Cores
2. Clicar no toggle de tema ‚Üí verificar troca dark/light + persist√™ncia ao recarregar
3. Acessar aba Eventos ‚Üí clicar Export ‚Üí verificar download JSON
4. Verificar que storage com disco >90% mostra alerta visual
5. Verificar sparkline de throughput global no card Traffic In
