@startuml protocol_sequence
!theme plain
skinparam backgroundColor #FEFEFE
skinparam defaultFontName Inter
skinparam sequenceMessageAlign center

title StreamGuard — Protocolo de Sessão de Backup

participant "Agent\n(Client)" as C
participant "Network\n(TCP)" as N
participant "Server" as S
database "Storage\n(Filesystem)" as D

== TLS 1.3 Handshake (mTLS) ==

C -> S : ClientHello + Certificate
S -> C : ServerHello + Certificate
note over C, S : Autenticação mútua via certificados X.509

== Handshake StreamGuard ==

C -> S : **HANDSHAKE**\n[Magic: "SGRD"] [Ver: 0x01]\n[AgentName: "web-server-01"] [\\n]

S -> S : Valida agent\nVerifica disco\nVerifica lock
alt Pronto
  S -> C : **ACK** [Status: 0x00 GO]
else Disco cheio
  S -> C : **NACK** [Status: 0x01 FULL] [msg]
  note over C : Agent agenda retry
else Backup em andamento
  S -> C : **NACK** [Status: 0x02 BUSY] [msg]
end

== Data Stream ==

S -> D : Cria arquivo .tmp
C -> C : fs.WalkDir\n→ tar.Writer\n→ gzip.Writer

loop Streaming contínuo (tar.gz bytes)
  C -> S : **DATA** (raw bytes)
  S -> D : io.Copy → .tmp file
  note right : SHA-256 calculado\ninline em ambos\n(TeeReader / MultiWriter)
end

C -> C : Fecha tar.Writer\ne gzip.Writer

== Finalization ==

C -> S : **TRAILER**\n[Magic: "DONE"]\n[SHA-256: 32 bytes]\n[Size: uint64]

S -> S : Compara SHA-256\nclient vs server
alt Checksum OK
  S -> D : Rename .tmp → timestamp.tar.gz
  S -> D : Remove backups excedentes\n(rotação por max_backups)
  S -> C : **FINAL ACK** [Status: 0x00 OK]
else Checksum mismatch
  S -> D : Remove .tmp
  S -> C : **FINAL ACK** [Status: 0x01 MISMATCH]
  note over C : Log error,\nagenda retry
end

== Conexão encerrada ==

C -> S : TCP FIN

@enduml

@startuml health_check
!theme plain
skinparam backgroundColor #FEFEFE
skinparam defaultFontName Inter

title StreamGuard — Health Check

participant "Agent CLI" as C
participant "Server" as S

== TLS 1.3 Handshake (mTLS) ==

C -> S : ClientHello + Certificate
S -> C : ServerHello + Certificate

== Health Check ==

C -> S : **PING** [Magic: "PING" 4 bytes]
S -> C : **PONG** [Status: 1B] [DiskFree: uint64] [\\n]

note over C
  Status:
  0x00 = Ready
  0x01 = Busy
  0x02 = Low disk
  0x03 = Maintenance
end note

C -> S : TCP FIN

@enduml
