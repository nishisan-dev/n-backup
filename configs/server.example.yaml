# NBackup Server — Exemplo de Configuração
# Copie para /etc/nbackup/server.yaml e ajuste os valores.

server:
  listen: "0.0.0.0:9847"

tls:
  ca_cert: /etc/nbackup/ca.pem
  server_cert: /etc/nbackup/server.pem
  server_key: /etc/nbackup/server-key.pem

storages:
  scripts:
    base_dir: /var/backups/scripts
    max_backups: 5
    compression_mode: gzip            # gzip|zst (default: gzip)
    assembler_mode: eager             # eager|lazy (default: eager)
    assembler_pending_mem_limit: 8mb  # limite de pending em memória no modo eager
    chunk_shard_levels: 1             # 1|2 — níveis de sharding de chunks no staging (default: 1)
    chunk_fsync: false                # true = fsync a cada write de chunk no staging (mais seguro, mais lento)

  home-dirs:
    base_dir: /var/backups/home
    max_backups: 10
    compression_mode: zst             # usa Zstandard para compressão mais rápida
    assembler_mode: lazy
    assembler_pending_mem_limit: 8mb
    chunk_fsync: false

logging:
  level: info                      # debug, info, warn, error
  format: json                     # json, text
  file: /var/log/nbackup/server.log # Log file dedicado (opcional)
  stream_stats: false              # Per-stream stats em sessões paralelas (padrão: false)

# SPA de Observabilidade — listener HTTP separado
web_ui:
  enabled: false                   # Habilita a interface web de observabilidade
  listen: "127.0.0.1:9848"        # Bind interno por padrão (segurança)
  read_timeout: 5s
  write_timeout: 15s
  idle_timeout: 60s
  events_file: /var/lib/nbackup/events.jsonl
  events_max_lines: 10000
  session_history_file: /var/lib/nbackup/session-history.jsonl
  session_history_max_lines: 5000
  active_sessions_file: /var/lib/nbackup/active-sessions.jsonl
  active_sessions_max_lines: 20000
  active_snapshot_interval: 5m
  storage_scan_interval: 1h               # Intervalo de refresh dos dados de storage (disco + contagem). Mínimo: 30s
  allow_origins:                   # ACL por IP/CIDR (obrigatória quando enabled)
    - "127.0.0.1/32"
    # - "10.0.0.0/8"              # Descomente para rede interna

# Buffer de chunks em memória — suaviza oscilações de I/O em HDs lentos.
# Quando habilitado, o servidor reserva a memória no startup e absorve chunks
# recebidos da rede no buffer antes de escrevê-los no disco.
# 0 (ou ausente) desabilita o buffer completamente (comportamento padrão).
#
# drain_ratio controla quando o drainer começa a escrever no assembler:
#   0.0 = write-through (drena imediatamente, sem bufferização)
#   0.5 = drena quando o buffer atingir 50% de ocupação (default recomendado)
#   1.0 = drena apenas quando o buffer estiver completamente cheio
#
chunk_buffer:
  size: 0              # ex: "64mb", "128mb", "256mb"  (0 = desligado)
  drain_ratio: 0.5     # 0.0 = write-through | 0.5 = drena a 50% (default) | 1.0 = drena quando cheio
