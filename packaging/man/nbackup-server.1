.\" nbackup-server(1) man page
.TH NBACKUP-SERVER 1 "February 2026" "nbackup VERSION_PLACEHOLDER" "NBackup Manual"
.SH NAME
nbackup\-server \- high\-performance streaming backup receiver
.SH SYNOPSIS
.B nbackup\-server
.RB [ \-\-config
.IR path ]
.SH DESCRIPTION
.B nbackup\-server
is a backup receiver that accepts streaming connections from
.B nbackup\-agent
instances over TCP with mutual TLS (mTLS) authentication.
.PP
Incoming data streams (tar.gz) are written atomically to disk: data is
first saved to a temporary file, then a SHA\-256 checksum is validated
against the agent's computed hash, and only upon match is the file renamed
to its final location. Automatic backup rotation removes the oldest backups
when the configured maximum is reached.
.PP
The server supports multiple named storages, each with independent base
directories and rotation policies. Multiple agents can connect
simultaneously, with one active backup session per agent:storage pair.
.SH OPTIONS
.TP
.BI \-\-config " path"
Path to the server configuration file in YAML format.
Default:
.IR /etc/nbackup/server.yaml .
.SH CONFIGURATION
The server is configured via a YAML file. Key sections:
.TP
.B server.listen
Address and port to listen on (e.g., "0.0.0.0:9847").
.TP
.B tls
Paths to CA certificate, server certificate, and server private key
for mTLS authentication.
.TP
.B storages
Map of named storages. Each storage has:
.B base_dir
(directory for backup files) and
.B max_backups
(maximum number of backups to retain per agent, default: 5).
.TP
.B logging.level
Log level: debug, info, warn, error (default: info).
.TP
.B logging.format
Log format: json, text (default: json).
.SH STORAGE LAYOUT
Backups are organized by storage name and agent name:
.PP
.RS
.nf
/var/backups/scripts/              \(<- storage "scripts"
\(bu web\-server\-01/
    \(bu 2026\-02\-10T02\-00\-00.tar.gz
    \(bu 2026\-02\-12T02\-00\-00.tar.gz
\(bu web\-server\-02/
    \(bu 2026\-02\-12T02\-00\-00.tar.gz

/var/backups/home/                 \(<- storage "home\-dirs"
\(bu web\-server\-01/
    \(bu 2026\-02\-11T02\-00\-00.tar.gz
.fi
.RE
.PP
Each storage rotates independently based on its
.B max_backups
setting.
.SH PROTOCOL
The server implements the NBackup binary protocol (NBKP) over TLS 1.3:
.TP
.B Handshake
Agent identifies itself with name and target storage. Server responds
with GO, FULL, BUSY, REJECT, or STORAGE_NOT_FOUND.
.TP
.B Data Stream
Raw tar.gz bytes streamed continuously. Server sends SACK (selective
acknowledgment) every 64MB.
.TP
.B Trailer
Agent sends SHA\-256 checksum and total size. Server validates and
responds with OK or CHECKSUM_MISMATCH.
.TP
.B Health Check
PING/PONG with disk free space reporting.
.TP
.B Resume
Agent can reconnect using session ID to resume interrupted transfers.
Sessions expire after 1 hour.
.TP
.B Parallel Streaming
Agents can open multiple TLS connections for the same session to
increase throughput (up to 8 streams).
.SH FILES
.TP
.I /etc/nbackup/server.yaml
Default server configuration file.
.TP
.I /etc/nbackup/ca.pem
Certificate Authority certificate.
.TP
.I /etc/nbackup/server.pem
Server certificate.
.TP
.I /etc/nbackup/server\-key.pem
Server private key (should be mode 0640).
.TP
.I /var/backups/nbackup/
Default base directory for backup storage.
.SH SIGNALS
.TP
.B SIGTERM, SIGINT
Graceful shutdown. Active backup sessions are completed before the
server stops accepting new connections.
.SH EXIT STATUS
.TP
.B 0
Successful execution (clean shutdown).
.TP
.B 1
Error (configuration, bind, or runtime failure).
.SH EXAMPLES
Start the server with default config:
.PP
.RS
.nf
nbackup\-server \-\-config /etc/nbackup/server.yaml
.fi
.RE
.PP
Start with custom config:
.PP
.RS
.nf
nbackup\-server \-\-config /opt/backup/server.yaml
.fi
.RE
.PP
Manage as a systemd service:
.PP
.RS
.nf
sudo systemctl start nbackup\-server
sudo systemctl status nbackup\-server
sudo journalctl \-u nbackup\-server \-f
.fi
.RE
.SH SECURITY
The server requires mutual TLS (mTLS) with TLS 1.3. Only agents presenting
certificates signed by the configured CA are accepted. Data integrity is
verified via SHA\-256 checksums computed independently by both agent and
server. Failed checksums result in automatic discard of the backup.
.SH SEE ALSO
.BR nbackup\-agent (1),
.BR tar (1),
.BR gzip (1),
.BR openssl (1),
.BR systemctl (1)
.SH BUGS
Report bugs at
.UR https://github.com/nishisan\-dev/n\-backup/issues
.UE .
.SH COPYRIGHT
Copyright (c) 2025 Nishisan. All rights reserved.
Licensed under the N\-Backup License (Non\-Commercial Evaluation).
